<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MyAI ‚Äî Find Hospitals</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <style>
        :root{ --accent-1:#0066cc; --accent-2:#2e7d32 }
        html,body{ height:100%; margin:0; }
        body{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-image: url('{{ url_for('serve_ai_image') }}');
            background-size: cover; background-position:center; background-attachment: fixed;
            color:#111; padding:18px;
        }

        .container{ max-width:1100px; margin:18px auto; display:grid; grid-template-columns: 1fr 420px; gap:18px; align-items:start }
        .left-panel, .right-panel{ background: rgba(255,255,255,0.95); border-radius:10px; padding:16px; box-shadow:0 8px 28px rgba(0,0,0,0.12) }

        .header-row{ display:flex; gap:12px; align-items:center; margin-bottom:12px }
        .header-row h2{ margin:0; color:var(--accent-2) }

        .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
        .action{ background:var(--accent-1); color:white; padding:10px 12px; border-radius:8px; border:none; cursor:pointer }

        .radius-control{ display:flex; gap:10px; align-items:center }
        .radius-control input[type=range]{ width:160px }

        #hospital-list{ margin-top:12px; max-height:60vh; overflow:auto }
        .hospital-item{ background:#f1f8f1; padding:10px; border-radius:8px; margin-bottom:10px }

        .news-toast{ position:fixed; right:18px; bottom:18px; min-width:260px; background:#fff; border-left:6px solid var(--accent-1); padding:12px 14px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.18); display:none }

        .chart-wrapper{ height:260px }

        .small-muted{ font-size:0.9rem; color:#666 }

        @media (max-width:1000px){ .container{ grid-template-columns: 1fr; } .right-panel{ order:2 } }
    </style>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet (small interactive map preview) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <div class="header-row">
                <h2>Find Hospitals Near You</h2>
                <div style="flex:1"></div>
                <a href="{{ url_for('index') }}" style="text-decoration:none"><button class="action">‚¨Ö Home</button></a>
            </div>

            <div class="controls">
                <button id="startBtn" class="action">üìç Use My Location</button>
                <div class="radius-control small-muted">Radius: <span id="radiusLabel">5</span> km
                    <input id="radiusRange" type="range" min="1" max="20" value="5">
                </div>
                <button id="refreshBtn" class="action">üîÑ Refresh</button>
            </div>

            <div id="hospital-list">
                <div class="small-muted">No results yet. Click "Use My Location".</div>
            </div>
        </div>

        <div class="right-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                <div><strong>Nearby Hospitals</strong><div class="small-muted">Distribution by distance</div></div>
                <button id="newsBtn" class="action">üì∞ Latest News</button>
            </div>
            <div class="chart-wrapper"><canvas id="distanceChart"></canvas></div>
            <div style="margin-top:12px">
                <strong>Map Preview</strong>
                <div id="map" style="height:220px; border-radius:8px; margin-top:8px"></div>
            </div>
            <div style="margin-top:14px">
                <strong>News & Alerts</strong>
                <div id="newsList" style="margin-top:8px; font-size:0.95rem; color:#333">No news yet.</div>
            </div>
        </div>
    </div>

    <div id="newsToast" class="news-toast"></div>

    <script>
    // UI elements
    const startBtn = document.getElementById('startBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const hospitalList = document.getElementById('hospital-list');
    const radiusRange = document.getElementById('radiusRange');
    const radiusLabel = document.getElementById('radiusLabel');
    const newsBtn = document.getElementById('newsBtn');
    const newsList = document.getElementById('newsList');
    const newsToast = document.getElementById('newsToast');

    let lastSearch = { lat: null, lng: null, radius: 5000 };
    let currentHospitals = [];
    let distanceChart = null;

    // Leaflet map state
    let map = null;
    let mapMarkers = [];
    function initMap(){
        if (map) return;
        map = L.map('map', { zoomControl:true, attributionControl:false }).setView([0,0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);
    }

    function clearMapMarkers(){
        mapMarkers.forEach(m => map.removeLayer(m));
        mapMarkers = [];
    }

    function updateMap(userLat, userLng, hospitals){
        initMap();
        if (!userLat || !userLng) return;
        map.setView([userLat, userLng], Math.min(14, Math.max(10, Math.floor(12 - Math.log10(hospitals.length+1)))));
        clearMapMarkers();
        // user marker
        const userMarker = L.circleMarker([userLat, userLng], { radius:8, color:'#1976d2', fillColor:'#2196f3', fillOpacity:0.9 }).addTo(map).bindPopup('You are here');
        mapMarkers.push(userMarker);
        // hospital markers (limit 20)
        hospitals.slice(0,20).forEach(h=>{
            const m = L.marker([h.lat, h.lng]).addTo(map).bindPopup(`<strong>${escapeHtml(h.name)}</strong><br>${h.distance.toFixed(2)} km`);
            mapMarkers.push(m);
        });
    }

    radiusRange.addEventListener('input', () => { radiusLabel.textContent = radiusRange.value; });
    startBtn.addEventListener('click', () => showPermissionPrompt());
    refreshBtn.addEventListener('click', () => {
        if (lastSearch.lat) searchHospitals(lastSearch.lat, lastSearch.lng, lastSearch.radius);
    });

    // Permission prompt (simple)
    function showPermissionPrompt(){
        const allow = confirm('MyAI will request your location to find nearby hospitals. Allow?');
        if (allow) requestLocation();
    }

    function requestLocation(){
        if (!navigator.geolocation){ alert('Geolocation not supported'); return; }
        hospitalList.innerHTML = '<div class="small-muted">Getting location‚Ä¶</div>';
        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude; const lng = pos.coords.longitude;
            const radius = Number(radiusRange.value) * 1000;
            lastSearch = { lat, lng, radius };
            searchHospitals(lat, lng, radius);
        }, err => {
            hospitalList.innerHTML = `<div class="small-muted">Location error: ${err.message}</div>`;
        }, { timeout:15000 });
    }

    async function searchHospitals(lat, lng, radius){
        hospitalList.innerHTML = '<div class="small-muted">Searching nearby hospitals‚Ä¶</div>';
        const query = `\n[out:json][timeout:25];\n(\n  node["amenity"="hospital"](around:${radius},${lat},${lng});\n  way["amenity"="hospital"](around:${radius},${lat},${lng});\n  relation["amenity"="hospital"](around:${radius},${lat},${lng});\n);\nout center;`;
        const endpoints = ['https://overpass-api.de/api/interpreter','https://overpass.kumi.systems/api/interpreter','https://overpass.openstreetmap.ru/api/interpreter'];
        let data = null;
        for (const ep of endpoints){
            try{
                const res = await fetch(`${ep}?data=${encodeURIComponent(query)}`);
                const text = await res.text();
                if (text.trim().startsWith('<')) continue;
                data = JSON.parse(text);
                break;
            }catch(e){ console.warn('overpass error', e); }
        }
        if (!data || !data.elements){ hospitalList.innerHTML = '<div class="small-muted">No hospitals found.</div>'; return; }
        currentHospitals = data.elements.map(el => {
            const lat = el.lat || el.center?.lat; const lng = el.lon || el.center?.lon; const distance = calculateDistance(lat, lng, lastSearch.lat, lastSearch.lng);
            return { name: el.tags?.name || 'Unknown', lat, lng, distance, phone: el.tags?.phone || el.tags?.['contact:phone'] || '', addr: el.tags?.['addr:street'] || '' };
        }).filter(h => !isNaN(h.distance));
        currentHospitals.sort((a,b)=>a.distance-b.distance);
        renderList(currentHospitals);
        renderChart(currentHospitals);
        populateNews(currentHospitals);
        // update small map preview with results
        try{ updateMap(lastSearch.lat, lastSearch.lng, currentHospitals); }catch(e){ console.warn('map update failed', e); }
    }

    function renderList(items){
        if (!items.length){ hospitalList.innerHTML = '<div class="small-muted">No hospitals found nearby.</div>'; return; }
        hospitalList.innerHTML = '';
        items.slice(0,50).forEach((h,i)=>{
            const el = document.createElement('div'); el.className='hospital-item';
            el.innerHTML = `<strong>${i+1}. ${escapeHtml(h.name)}</strong><div class="small-muted">${h.distance.toFixed(2)} km</div><div>${escapeHtml(h.addr)}</div><div style="margin-top:6px"><a href="https://www.google.com/maps/search/${encodeURIComponent(h.name)}/@${h.lat},${h.lng},15z" target="_blank">Open in Google Maps</a></div>`;
            hospitalList.appendChild(el);
        });
    }

    function renderChart(items){
        const bins = [1,3,5,10,20]; // km
        const counts = bins.map(() => 0);
        items.forEach(h=>{ const d = h.distance; for (let i=0;i<bins.length;i++){ if (d <= bins[i]){ counts[i]++; break; } } });
        const labels = bins.map(b=>`‚â§ ${b} km`);
        const ctx = document.getElementById('distanceChart').getContext('2d');
        if (distanceChart) distanceChart.destroy();
        distanceChart = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Hospitals', data:counts, backgroundColor:'#4caf50' }] }, options:{ responsive:true, plugins:{ legend:{ display:false } } } });
    }

    function populateNews(items){
        // Generate some mock news based on nearest hospital names (demo); replace with real API if available
        const news = [];
        if (!items.length){ newsList.innerHTML = 'No news available.'; return; }
        news.push(`New outpatient hours at ${items[0].name}`);
        if (items[1]) news.push(`COVID-19 testing available at ${items[1].name}`);
        newsList.innerHTML = news.map(n=>`<div>‚Ä¢ ${escapeHtml(n)}</div>`).join('');
        // show toast for the latest
        showToast(news[0]);
    }

    function showToast(text){
        newsToast.textContent = text; newsToast.style.display='block';
        setTimeout(()=>{ newsToast.style.display='none'; }, 6000);
    }

    newsBtn.addEventListener('click', ()=>{ if (newsList.innerHTML.trim()==='') alert('No news yet'); else alert(newsList.textContent); });

    // small helpers
    function calculateDistance(lat1, lon1, lat2, lon2){
        // haversine (km)
        const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
        const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
        return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"]+/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    // expose a quick demo: try searching with a fallback location if user denies
    // optional: auto-run a test location for dev when served on localhost
    </script>
</body>
</html>
